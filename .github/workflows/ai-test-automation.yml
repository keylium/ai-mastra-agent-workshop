name: AI Test Automation Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

jobs:
  ai-test-automation:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Trigger AI Test Workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BROWSER_USE_API_KEY: ${{ secrets.BROWSER_USE_API_KEY }}
        run: |
          node -e "
          const { mastra } = require('./dist/mastra/index.js');
          
          async function runWorkflow() {
            try {
              const pullRequestUrl = 'https://github.com/${{ github.repository }}/pull/${{ github.event.number }}';
              console.log('Starting AI test workflow for PR:', pullRequestUrl);
              
              const result = await mastra.runWorkflow({
                workflowId: 'pr-workflow',
                data: { pullRequestUrl }
              });
              
              console.log('Workflow completed:', result);
            } catch (error) {
              console.error('Workflow failed:', error);
              process.exit(1);
            }
          }
          
          runWorkflow();
          "
          
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš¨ AI Test Automation Pipeline failed. Please check the workflow logs for details.'
            })